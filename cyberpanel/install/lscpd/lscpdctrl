#!/bin/bash
### BEGIN INIT INFO
# Provides:          lscpd
# Required-Start:    $local_fs $remote_fs $network $syslog
# Required-Stop:     $local_fs $remote_fs $network $syslog
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: CyberPanel Daemon
### END INIT INFO

EXECUTABLE=/usr/local/lscp/bin/lscpd
PIDFILE=/tmp/lscpd/lscpd.pid
LOG_DIR=/usr/local/lscp/logs
HOST=0.0.0.0:8090
MODULE=/usr/local/CyberCP/CyberCP/wsgi.py:application

# Unset PYTHONHOME to allow finding system stdlib
unset PYTHONHOME
# Set PYTHONPATH to venv site-packages and app root
export PYTHONPATH=/usr/local/CyberCP/lib/python3.12/site-packages:/usr/local/CyberCP

mkdir -p /tmp/lscpd
chown lscpd:lscpd /tmp/lscpd
mkdir -p $LOG_DIR
chown lscpd:lscpd $LOG_DIR

case "$1" in
    start)
        echo "Starting lscpd..."
        if [ -f $PIDFILE ]; then
            kill -0 $(cat $PIDFILE) 2>/dev/null
            if [ $? -eq 0 ]; then
                echo "lscpd is already running."
                exit 0
            fi
        fi
        
        # Start in background with -a for address
        nohup $EXECUTABLE -a $HOST -m $MODULE > $LOG_DIR/lscpd.out 2> $LOG_DIR/lscpd.err &
        PID=$!
        echo $PID > $PIDFILE
        echo "lscpd started with PID $PID"
        ;;
    stop)
        echo "Stopping lscpd..."
        if [ -f $PIDFILE ]; then
            PID=$(cat $PIDFILE)
            kill $PID 2>/dev/null
            rm -f $PIDFILE
        else
            killall lscpd 2>/dev/null
        fi
        ;;
    restart|reload)
        $0 stop
        sleep 2
        $0 start
        ;;
    status)
        if [ -f $PIDFILE ]; then
            PID=$(cat $PIDFILE)
            kill -0 $PID 2>/dev/null
            if [ $? -eq 0 ]; then
                echo "lscpd is running with PID $PID"
            else
                echo "lscpd is not running (PID file exists but process dead)"
            fi
        else
            echo "lscpd is not running"
        fi
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|status}"
        exit 1
        ;;
esac
exit 0